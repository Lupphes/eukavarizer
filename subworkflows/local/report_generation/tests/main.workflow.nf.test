nextflow_workflow {

    name "Test Workflow REPORT_GENERATION"
    script "../main.nf"
    workflow "REPORT_GENERATION"
    config "subworkflows/local/report_generation/tests/nextflow.config"
    tag "subworkflows"
    tag "subworkflows_local"
    tag "report_generation"

    /*
     * Test scenario 1: Report generation with all required inputs
     * This test validates the complete report generation workflow.
     * Expected behavior: The workflow should generate an HTML report using:
     * - SURVIVOR merged VCF and stats
     * - BCFtools merged VCF, index, and stats
     * - Reference genome FASTA and FAI index
     * The report provides an overview of structural variant calling results.
     */
    test("Generate report with SV data - stub") {
        options '-stub'

        when {
            workflow {
                """
                input[0] = 4932  // Yeast taxonomy ID
                input[1] = "$outputDir"
                input[2] = channel.value([[id: 'survivor'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/vcf/gridss.somatic.vcf')])
                input[3] = channel.value([[id: 'survivor_stats'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.bed')])
                input[4] = channel.value([[id: 'bcfmerge'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/vcf/test.rnaseq.vcf.gz')])
                input[5] = channel.value([[id: 'bcfmerge_tbi'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/vcf/test.rnaseq.vcf.gz.tbi')])
                input[6] = channel.value([[id: 'bcfmerge_stats'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.sizes')])
                input[7] = channel.value([[id: 'ref_faidx'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta.fai')])
                input[8] = channel.value([[id: 'genome'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta')])
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.report_file != null },
                { assert snapshot(workflow.out).match() }
            )
        }
    }

    /*
     * Test scenario 2: Report generation with different taxonomy
     * This test validates report generation with human taxonomy ID.
     * Expected behavior: The workflow should generate a report regardless of taxonomy ID,
     * demonstrating that the taxonomy parameter is properly passed through to VARIFY.
     */
    test("Generate report with human taxonomy - stub") {
        options '-stub'

        when {
            workflow {
                """
                input[0] = 9606  // Human taxonomy ID
                input[1] = "$outputDir"
                input[2] = channel.value([[id: 'survivor'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/vcf/gridss.somatic.vcf')])
                input[3] = channel.value([[id: 'survivor_stats'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.bed')])
                input[4] = channel.value([[id: 'bcfmerge'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/vcf/genmod.vcf.gz')])
                input[5] = channel.value([[id: 'bcfmerge_tbi'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/vcf/NA12878_chrM.vcf.gz.tbi')])
                input[6] = channel.value([[id: 'bcfmerge_stats'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.sizes')])
                input[7] = channel.value([[id: 'ref_faidx'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta.fai')])
                input[8] = channel.value([[id: 'genome'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta')])
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.report_file != null },
                { assert snapshot(workflow.out).match() }
            )
        }
    }

    /*
     * Test scenario 3: Verify FAI file is properly passed through
     * This test specifically validates that the FAI index file is correctly
     * passed from the workflow to the VARIFY process.
     */
    test("Verify FAI file staging - stub") {
        options '-stub'

        when {
            workflow {
                """
                input[0] = 4932
                input[1] = "$outputDir"
                input[2] = channel.value([[id: 'survivor'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/vcf/test.rnaseq.vcf')])
                input[3] = channel.value([[id: 'survivor_stats'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.bed')])
                input[4] = channel.value([[id: 'bcfmerge'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/vcf/test.rnaseq.vcf.gz')])
                input[5] = channel.value([[id: 'bcfmerge_tbi'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/vcf/test.rnaseq.vcf.gz.tbi')])
                input[6] = channel.value([[id: 'bcfmerge_stats'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.sizes')])
                input[7] = channel.value([[id: 'ref_faidx'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta.fai')])
                input[8] = channel.value([[id: 'genome'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta')])
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.report_file != null },
                { assert workflow.out.versions != null }
            )
        }
    }
}
