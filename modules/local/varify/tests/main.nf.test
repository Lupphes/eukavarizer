nextflow_process {

    name "Test Process VARIFY"
    script "../main.nf"
    process "VARIFY"
    tag "varify"
    tag "modules"
    tag "modules_local"

    test("Generate SV report - stub") {
        options '-stub'

        when {
            params {
                outdir = "$outputDir"
            }
            process {
                """
                input[0] = 4932  // taxonomy_id (yeast)
                input[1] = "$outputDir"
                input[2] = [ [id: 'survivor'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/vcf/test.rnaseq.vcf') ]
                input[3] = [ [id: 'survivor_stats'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.bed') ]
                input[4] = [ [id: 'bcfmerge'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/vcf/test.rnaseq.vcf.gz') ]
                input[5] = [ [id: 'bcfmerge_tbi'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/vcf/test.rnaseq.vcf.gz.tbi') ]
                input[6] = [ [id: 'bcfmerge_stats'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.sizes') ]
                input[7] = [ [id: 'ref_faidx'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta.fai') ]
                input[8] = [ [id: 'ref'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta') ]
                input[9] = "test"  // profile
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() },
                { assert process.out.report_file },
                { assert process.out.report_file.get(0).toString().endsWith('.html') },
                { assert process.out.genome_files },
                { assert process.out.versions }
            )
        }
    }

    test("Generate SV report with different taxonomy - stub") {
        options '-stub'

        when {
            params {
                outdir = "$outputDir"
            }
            process {
                """
                input[0] = 9606  // taxonomy_id (human)
                input[1] = "$outputDir"
                input[2] = [ [id: 'survivor'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/vcf/test.rnaseq.vcf') ]
                input[3] = [ [id: 'survivor_stats'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.bed') ]
                input[4] = [ [id: 'bcfmerge'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/vcf/test.rnaseq.vcf.gz') ]
                input[5] = [ [id: 'bcfmerge_tbi'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/vcf/test.rnaseq.vcf.gz.tbi') ]
                input[6] = [ [id: 'bcfmerge_stats'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.sizes') ]
                input[7] = [ [id: 'ref_faidx'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta.fai') ]
                input[8] = [ [id: 'ref'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta') ]
                input[9] = "docker"  // profile
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() },
                { assert process.out.report_file },
                { assert process.out.genome_files },
                { assert process.out.versions }
            )
        }
    }

    test("Verify FAI file is staged correctly - stub") {
        options '-stub'

        when {
            params {
                outdir = "$outputDir"
            }
            process {
                """
                input[0] = 4932
                input[1] = "$outputDir"
                input[2] = [ [id: 'survivor'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/vcf/test.rnaseq.vcf') ]
                input[3] = [ [id: 'survivor_stats'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.bed') ]
                input[4] = [ [id: 'bcfmerge'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/vcf/test.rnaseq.vcf.gz') ]
                input[5] = [ [id: 'bcfmerge_tbi'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/vcf/test.rnaseq.vcf.gz.tbi') ]
                input[6] = [ [id: 'bcfmerge_stats'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.sizes') ]
                input[7] = [ [id: 'ref_faidx'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta.fai') ]
                input[8] = [ [id: 'ref'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta') ]
                input[9] = "test"
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() },
                // Verify that genome_files contains both FASTA and FAI
                { assert process.out.genome_files.get(0).size() >= 2 },
                { assert process.out.versions }
            )
        }
    }
}
